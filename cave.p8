pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--sample cave dweller
--by romellem

function _init()
	game_over=false
	make_cave()
	make_player()
	init_enemies()
end

function _update()
	if (not game_over) then
		update_cave()
		move_player()
		update_enemies()
		check_hit()
	else
		if (btnp(5)) _init() --restart
	end
end

function _draw()
	cls()
	draw_cave()
	draw_player()
	draw_enemies()
	
	if (game_over) then
		print("game over!", 44, 44, 7)
		print("your score:"..player.score, 34, 54, 7)
		print("press ❎ to play again", 18, 72, 12)
	else
		print("score:"..player.score, 2, 2, 7)
	end
end
-->8
function make_player()
	player={}
	player.x=24    --position
	player.y=60
	player.dy=0    --fall speed
	player.rise=1  --sprites
	player.fall=2
	player.dead=3
	player.speed=2 --fly speed
	player.score=0
end

function draw_player()
	if (game_over) then
		spr(player.dead, player.x, player.y)
	elseif (player.dy < 0) then
		spr(player.rise, player.x, player.y)
	else
		--falling
		spr(player.fall, player.x, player.y)
	end
end

function move_player()
	gravity=0.12 --increase this value to increase gravity
	player.dy += gravity
	
	--jump
	if (btnp(⬆️)) then
		player.dy -= 4
		sfx(0)
	elseif (btnp(⬇️)) then
		player.dy += 2
		sfx(4)
	end
	
	--move to new position
	player.y += player.dy

	--update score
	player.score+=player.speed
end

function check_hit()
	for i=player.x,player.x+7 do
		--check if player is touching cave
		if (cave[i+1].top > player.y
			or cave[i+1].btm < player.y+7) then
			die()
		end
	end
	
	--check if player is touching enemy
	--uses 6x6 box for enemy to give some collision wiggle room
	for enem in all(enemies) do
		if (box_hit(
			player.x, player.y, 8, 8,
			enem.x+1, enem.y+1, 6, 6)
		) then
			die()
		end
	end
end

function die()
	game_over=true
	sfx(1)
end
-->8
function make_cave()
	cave={{["top"]=5, ["btm"]=119}}
	top=45  --how low can the ceiling go?
	btm=85  --how high can the floor get?
end

function update_cave()
	--remove the back of the cave
	if (#cave > player.speed) then
		for i=1,player.speed do
			del(cave, cave[1])
		end
	end
	
	--add more cave
	while (#cave < 128) do
		local col={}
		local up=flr(rnd(7)-3)
		local dwn=flr(rnd(7)-3)
		
		--clamp our values
		col.top = mid(3, cave[#cave].top+up, top)
		col.btm = mid(btm, cave[#cave].btm+dwn, 124)
		add(cave, col)
	end
end

function draw_cave()
	top_color=5 --adjust these values to get different colors!
	btm_color=6
	
	for i=1,#cave do
		line(i-1, 0, i-1, cave[i].top, top_color)
		line(i-1, 127, i-1, cave[i].btm, btm_color)
	end
end
-->8
function init_enemies()
	enemies={}
	
	--lower this value to change y movement liklihood
	enemy_y_prob=0.1
	
	--lower this value to change likliehood of creating an enemy
	enemy_gen_prob=0.03
	
	--max enemies on the screen
	enemy_limit=4
end

function make_enemy()
	--get last cave column to determine y range for enemy
	local e_top = cave[#cave].top
	local e_btm = cave[#cave].btm

	local enemy={}
	enemy.x=127

	--create y value between opening in cave
	enemy.y=flr(rnd(e_btm-e_top+2)) + e_top-2
	enemy.s=4
	
	enemy.score=100
	
	add(enemies,enemy)
end

function draw_enemies()
	for e in all(enemies) do
		spr(e.s, e.x, e.y)
		e.x -= 1
		
		-- (0 or 1) * 2 = (0 or 2) - 1 = (1 or -1)
		local dy=flr(rnd(2))*2 - 1
		if (rnd(1)<enemy_y_prob) then
			e.y += dy
		end
	end
end

function gen_enemies()
	if (#enemies < enemy_limit) then
		if (rnd(1) < enemy_gen_prob) then
			make_enemy()
		end
	end
end

function prune_enemies()
	for e in all(enemies) do
	  if (e.x < 0) then
	  	del(enemies, e)
	  	
	  	player.score += e.score
	  	sfx(2)
	  	sfx(3)
	  end
	end
end

function update_enemies()
	prune_enemies()
	gen_enemies()
end
-->8
function box_hit(
	x1,y1,
	w1,h1,
	x2,y2,
	w2,h2)
	
	local hit=false
	
	local xs=w1/2 + w2/2
	local ys=h1/2 + h2/2
	local xd=abs((x1 + (w1/2)) - (x2 + (w2/2)))
	local yd=abs((y1 + (h1/2)) - (y2 + (h2/2)))
	
	if (xd<xs and yd<ys) then
		hit=true
	end
	
	return hit
end
__gfx__
0000000000aaaa0000aaaa0000888800002222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aaaaaa00aaaaaa008888880028228220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700aa1aa1aaaaaaaaaa88988988288228820000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000aaaaaaaaaa1aa1aa88888888218221800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000aa1111aaaaaaaaaa88899888222222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700aaa11aaaaaa11aaa88988988233ee2200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aaaaaa00aa11aa008888880023332000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000aaaa0000aaaa0000888800002220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55577557755775777577755555775577757775555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55755575557575757575555755575555757575555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55777575557575775577555000575577757775555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55557575557575757575550700570575557575555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55775557757755707577750000777077757775555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555505550000000000055055555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555500500000000000000055555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55505555555555000500000000000000000555555555555555555555555555555555555555555555555555550050055555555555555500555555555555555555
05505555555505000500000000000000000555555555555555555555555555555555555555555555555555550000055555555555550500555555555555555555
05000555555500000000000000000000000005555555555555555555555555555555555555555555555555500000055555555555550000055555505555555555
00000555555000000000000000000000000005555555555555550555555555555555555555555555555550000000000555555555500000005555000055555505
00000555555000000000000000000000000005555555555555550555555555555555555555555555555500000000000555555505500000005555000005550505
00000055555000000000000000000000000000555555555555550555555555555555555555555555555500000000000055555005000000000500000000550005
00000055050000000000000000000000000000555555555555500055555555555555555555555555555000000000000055555005000000000000000000500000
00000005050000000000000000000000000000555555555550500055555555555555555555555005550000000000000055555000000000000000000000000000
00000000050000000000000000000000000000055055555550000055555555555555555555555005500000000000000000550000000000000000000000000000
00000000000000000000000000000000000000055055555000000005555555555555555555005005500000000000000000000000000000000000000000000000
00000000000000000000000000000000000000005005550000000000555555555555555555000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000005500000000000055555505555555555000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000055505505555555550000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000055505000555555550000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000005500000555555500000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000005000000055555000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000005000000055555000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000055555000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000005550000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000aaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000aaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000aa1aa1aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000aaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000aa1111aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000aaa11aaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000aaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000aaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000060600000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000600000000666600000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000600000000666600000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000006600000006666660000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000066660000666666660000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000060006600000000000000000066666660666666660000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000060606606000000000000000666666660666666666600000000000000000000000000000000000000000000000000000000000000
60000000000000000000000060606606000000000000000666666666666666666660000000000000000000000000000000000000000000000000000000000000
60000000000000000000000666666666000000000000000666666666666666666660000000000000000000000000000000000000000000000000000000000000
60000000000000000000000666666666600000000000006666666666666666666660000000000000000000000060006000000000000000000000000000000000
66000000000000000000000666666666600000006600006666666666666666666666000000000000000600660060006600000000000000000000000000000000
66000000000000006000006666666666600000006660606666666666666666666666000000000000000606666660006600000000000000000000000000000000
66000000600000006000066666666666660600066666666666666666666666666666000060006000006606666666066600600000000006600000060000000000
66606000600600666000066666666666660600066666666666666666666666666666600666006000006666666666066666600000000006660000066006000060
66606006660600666600066666666666660660666666666666666666666666666666600666606600006666666666066666660006060006660000066006606060
66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666
66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666
66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666
66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666

__sfx__
010400001005015050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011000001f050000001b0500000018050000000c0500c0500c0500c0500c0500c0500c05003050070500005000000180000000000000000000000000000000000000000000000000000000000000000000000000
002000002451500505005050050500505005050050500505005050050500505005050050500505005050050500505005050050500505005050050500505005050050500505005050050500505005050000500005
011000002b51500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005
000400001505010050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01100000183200c320103201032013320133200c3200c3200c420003000042000300003000030024520003001332000300173201332013320000001332013320153200c320113200000016220003000c3200c320
011000000c610006000060000600246100060000600006000c610006000060000600246100060000600006000c610006000060000600246100060000600006000c6100060000600006000c610006002861000000
__music__
02 0a0b4344

